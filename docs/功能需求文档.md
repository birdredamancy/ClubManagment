# 校园社区管理系统 — 功能需求文档

> 技术栈：Java 17 + Spring Boot 4.x + MyBatis-Plus | PostgreSQL + Redis | Vue 3 + Arco Design

---

## 一、项目概述

### 1.1 项目定位

面向高校的校园社区平台，为在校师生提供**社交聊天**、**校园信息墙**和**AI 智能内容总结**三大核心能力，构建线上校园交流空间。

### 1.2 目标用户

| 角色 | 说明 |
|------|------|
| 普通用户（学生/教师） | 注册登录、发帖互动、实时聊天、查看 AI 总结 |
| 管理员 | 内容审核、用户管理、手动触发 AI 总结 |
| 版主（可选） | 协助管理特定分类的帖子 |

### 1.3 系统架构概览

```
┌──────────────────────────────────────────────────┐
│           前端 (Vue 3 + Arco Design)              │
│                                                    │
│   登录注册    校园墙    聊天模块     AI总结         │
│      │          │     WebSocket       │            │
└──────┼──────────┼─────────┼───────────┼────────────┘
       │          │         │           │
       ▼          ▼         ▼           ▼
┌──────────────────────────────────────────────────┐
│            Nginx 反向代理 + SSL                    │
└──────────────────────────────────────────────────┘
       │          │         │           │
       ▼          ▼         ▼           ▼
┌──────────────────────────────────────────────────┐
│           后端 (Spring Boot + MyBatis-Plus)        │
│                                                    │
│  用户服务  帖子服务  聊天服务(WS)  AI摘要服务      │
│      │         │         │            │            │
│      ▼         ▼         ▼            ▼            │
│  PostgreSQL   Redis             外部AI大模型API    │
│  (持久存储)   (缓存/会话/计数)  (DeepSeek等)       │
└──────────────────────────────────────────────────┘
```

---

## 二、功能模块详细需求

### 2.1 模块一：用户系统

#### 2.1.1 用户注册

- **功能描述**：新用户填写信息完成注册，注册后自动创建用户详情记录
- **业务规则**：
  - 用户名全局唯一，长度 4-20 位，仅允许字母、数字、下划线
  - 密码长度 6-20 位，后端使用 BCrypt 加密存储，**禁止明文存储**
  - 邮箱格式校验，全局唯一
  - 注册成功后自动生成业务用户 ID（雪花算法），角色默认为 `USER`
  - 同时创建一条 `user_profile` 记录（学号、专业等后续可编辑补充）

#### 2.1.2 用户登录

- **功能描述**：用户通过用户名+密码登录，获取访问令牌
- **业务规则**：
  - 校验用户名是否存在，密码是否匹配（BCrypt 比对）
  - 登录成功后生成 JWT Token，有效期 7 天
  - Token 同时存入 Redis（用于主动登出时作废 Token）
  - 账号状态为"禁用"时拒绝登录
  - 返回 Token 和用户基本信息（不含密码）

#### 2.1.3 用户信息管理

- **获取个人信息**：根据 Token 解析用户 ID，返回用户基本信息 + 详情信息
- **修改个人信息**：可修改昵称、头像、个人简介、专业、年级等
- **缓存策略**：用户信息优先从 Redis 读取，缓存不存在时查数据库并回写缓存（缓存 30 分钟）

#### 2.1.4 身份验证机制

- 所有需要登录的接口，请求头必须携带 `Authorization: Bearer {token}`
- 后端通过拦截器统一校验 Token 有效性（JWT 签名 + Redis 是否存在）
- Token 无效或过期返回 HTTP 401

---

### 2.2 模块二：校园墙（帖子系统）

#### 2.2.1 发布帖子

- **功能描述**：用户发布图文帖子到校园墙，可选择分类和匿名
- **业务规则**：
  - 正文内容必填，最大 2000 字
  - 图片可选，最多 9 张，单张不超过 10MB
  - 必须选择一个帖子分类
  - 可选择匿名发布（匿名帖子在展示时隐藏发布者信息）
  - 发布成功后返回帖子信息

#### 2.2.2 帖子分类

| 分类标识 | 显示名称 | 使用场景 |
|---------|---------|---------|
| `general` | 日常 | 日常分享、校园生活、吐槽 |
| `confession` | 表白墙 | 匿名或实名表白 |
| `lost_found` | 失物招领 | 丢失物品寻找、捡到物品归还 |
| `trade` | 二手交易 | 卖书、电子产品、生活用品等 |
| `help` | 求助 | 学业求助、生活求助 |

#### 2.2.3 帖子列表（分页浏览）

- **功能描述**：分页展示校园墙帖子，支持按分类筛选
- **业务规则**：
  - 默认按发布时间倒序排列，每页 10 条
  - 支持按分类筛选（传 category 参数）
  - 匿名帖子显示"匿名用户"，隐藏头像和用户 ID
  - 每条帖子附带：点赞数、评论数、浏览数、当前用户是否已点赞
  - 只展示状态为"正常"的帖子（status=1）

#### 2.2.4 帖子详情

- **功能描述**：查看单条帖子的完整内容及评论列表
- **业务规则**：
  - 进入详情页时，浏览次数 +1（通过 Redis 计数，异步同步到数据库）
  - 评论列表按时间正序排列，支持树形结构（评论的回复）
  - 返回帖子完整信息 + 评论列表 + 发布者信息

#### 2.2.5 点赞/取消点赞

- **功能描述**：用户对帖子进行点赞或取消点赞
- **业务规则**：
  - 同一用户对同一帖子只能点赞一次，再次点击为取消
  - 点赞状态使用 Redis Set 存储（`post:like:{postId}` -> 存储 userId 集合）
  - 点赞数变更后异步更新数据库的 `like_count` 冗余字段
  - 返回最新的点赞状态和点赞总数

#### 2.2.6 评论功能

- **功能描述**：用户对帖子发表评论，或回复某条评论
- **业务规则**：
  - 评论内容必填，最大 500 字
  - 支持二级评论结构：顶级评论（parent_id=0）和回复评论（parent_id=被回复评论的 ID）
  - 发表评论后，帖子的 `comment_count` +1
  - 评论不支持匿名（即使帖子是匿名发布的，评论者信息也会展示）

#### 2.2.7 帖子删除

- **功能描述**：用户可删除自己发布的帖子，管理员可删除任意帖子
- **业务规则**：
  - 软删除，将帖子 status 置为 0
  - 仅帖子发布者或管理员角色可操作

---

### 2.3 模块三：社交聊天

#### 2.3.1 通信方式选择

本系统聊天功能使用 **WebSocket** 实现实时通信：

| 对比项 | HTTP 轮询 | WebSocket |
|-------|----------|-----------|
| 实时性 | 差（依赖轮询间隔） | 好（服务端主动推送） |
| 资源消耗 | 高（频繁建立连接） | 低（一次连接持续使用） |
| 适用场景 | 非实时数据 | 即时聊天、实时通知 |

**设计决策**：聊天模块同时使用两种通信方式：
- **WebSocket**：实时消息收发、在线状态通知、已读回执
- **HTTP REST**：创建聊天室、获取历史消息（分页）、获取会话列表

#### 2.3.2 私聊

- **功能描述**：两个用户之间的一对一聊天
- **业务规则**：
  - 用户 A 向用户 B 发起私聊时，系统查找是否已存在两人的私聊室
  - 若不存在则自动创建（room_type=PRIVATE），并将两人加为成员
  - 私聊室没有群名称和群头像，前端展示对方的昵称和头像
  - 私聊室不可添加新成员

#### 2.3.3 群聊

- **功能描述**：多个用户组成的群组聊天
- **业务规则**：
  - 创建者指定群名和初始成员列表（至少 2 人，含创建者自己）
  - 创建者自动成为群主（role=OWNER）
  - 群主可添加/移除成员、修改群名、解散群聊
  - 群管理员（role=ADMIN）可添加/移除普通成员
  - 群成员上限 200 人

#### 2.3.4 消息发送与接收

- **功能描述**：用户在聊天室内发送和接收实时消息
- **业务规则**：
  - 支持的消息类型：文本（TEXT）、图片（IMAGE）、文件（FILE）、系统消息（SYSTEM）
  - 消息发送流程：
    1. 客户端通过 WebSocket 发送消息到服务端
    2. 服务端将消息持久化到数据库（chat_message 表）
    3. 服务端查找该聊天室的所有成员
    4. 在线成员：通过 WebSocket 实时推送
    5. 离线成员：Redis 未读消息计数 +1
  - 消息不可编辑，但可以撤回（status 置为 0，仅限发送后 2 分钟内）

#### 2.3.5 WebSocket 消息协议

**客户端 -> 服务端（发送消息）：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | String | 是 | 消息类型：CHAT / READ |
| roomId | Long | 是 | 聊天室 ID |
| content | String | 是(CHAT时) | 消息内容 |
| msgType | String | 是(CHAT时) | TEXT / IMAGE / FILE |

**服务端 -> 客户端（推送消息）：**

| 字段 | 类型 | 说明 |
|------|------|------|
| type | String | CHAT / ONLINE / OFFLINE / READ |
| roomId | Long | 聊天室 ID |
| senderId | Long | 发送者用户 ID |
| senderName | String | 发送者昵称 |
| senderAvatar | String | 发送者头像 |
| content | String | 消息内容 |
| msgType | String | TEXT / IMAGE / FILE / SYSTEM |
| createdAt | String | 发送时间 |

#### 2.3.6 会话列表

- **功能描述**：展示用户参与的所有聊天室，按最近消息时间排序
- **业务规则**：
  - 每个会话显示：聊天室名称/对方昵称、最后一条消息摘要、最后消息时间、未读消息数
  - 未读消息数从 Redis 读取
  - 进入某个聊天室后，清零该聊天室的未读计数

#### 2.3.7 历史消息

- **功能描述**：分页加载某个聊天室的历史消息
- **业务规则**：
  - 按时间倒序分页查询，每页 20 条
  - 前端上滑加载更多（类似微信聊天记录）
  - 撤回的消息显示为"该消息已被撤回"

#### 2.3.8 在线状态

- **功能描述**：展示用户的在线/离线状态
- **业务规则**：
  - 用户建立 WebSocket 连接后标记为在线（Redis 存储，5 分钟过期）
  - 客户端每 3 分钟发送心跳，服务端续期 Redis 在线标记
  - 连接断开后从 Redis 删除在线标记
  - WebSocket 连接断开后，客户端自动重连（最多 5 次，间隔 3 秒）

---

### 2.4 模块四：AI 总结校园墙

#### 2.4.1 功能描述

系统将校园墙近期帖子内容汇总后，发送给外部 AI 大模型 API，生成结构化的内容摘要，帮助用户快速了解校园热点动态。

#### 2.4.2 AI 总结类型

| 类型 | 标识 | 触发方式 | 说明 |
|------|------|---------|------|
| 每日热点 | DAILY | 定时任务（每天 23:00 自动执行） | 总结当天所有热门帖子 |
| 每周精选 | WEEKLY | 定时任务（每周日 23:00 自动执行） | 总结本周精华内容 |
| 分类热点 | CATEGORY | 管理员手动触发 | 总结指定分类下指定时间段的内容 |

#### 2.4.3 AI 总结的生成流程

```
1. 获取指定时间范围内的帖子（按点赞数排序，最多取 100 条）
2. 将帖子内容拼接为文本，构建 Prompt 发送给 AI API
3. AI 返回结构化摘要（3-5 个热点话题 + 校园氛围总结）
4. 将摘要结果存入 ai_summary 表
5. 使用 Redis 分布式锁防止同一时间重复生成
```

#### 2.4.4 AI 摘要输出格式

每次 AI 总结应包含以下结构化内容：

| 字段 | 说明 |
|------|------|
| 热点话题列表 | 3-5 个话题，每个包含：话题标题、一句话概括、涉及帖子数量 |
| 校园氛围总结 | 一句话描述当前校园整体氛围 |
| 覆盖帖子数 | 本次总结涉及的帖子总数 |
| 时间范围 | 本次总结覆盖的起止时间 |

#### 2.4.5 AI 摘要的查看

- **功能描述**：用户可查看历史 AI 摘要列表
- **业务规则**：
  - 分页展示，按生成时间倒序排列
  - 支持按总结类型（DAILY / WEEKLY / CATEGORY）筛选
  - 所有已登录用户均可查看

#### 2.4.6 手动触发生成

- **功能描述**：管理员可手动触发生成指定类型和时间范围的 AI 摘要
- **业务规则**：
  - 仅管理员角色可操作
  - 需指定：总结类型、分类（可选）、起止时间
  - 同一时间只能有一个生成任务在执行（Redis 分布式锁控制）
  - 若指定时间范围内无帖子，返回提示信息

#### 2.4.7 推荐的外部 AI API

| 服务 | 特点 | 备注 |
|------|------|------|
| DeepSeek API | 中文能力强、性价比高 | 兼容 OpenAI 接口格式 |
| 通义千问（阿里） | 稳定可靠、有免费额度 | 适合学生项目 |
| 智谱 AI (ChatGLM) | 国产开源、支持私有化部署 | 可本地运行 |

---

## 三、数据库设计

### 3.1 实体关系图（ER）

```
Users(用户) ──1:1──> UserProfile(用户详情)
Users(用户) ──1:N──> Post(帖子)
Users(用户) ──1:N──> Comment(评论)
Users(用户) ──M:N──> ChatRoom(聊天室)     通过 ChatRoomMember 中间表
ChatRoom    ──1:N──> ChatMessage(聊天消息)
Post(帖子)  ──1:N──> Comment(评论)
Post(帖子)  ──1:N──> PostLike(点赞)
```

### 3.2 数据表清单

#### 3.2.1 users — 用户表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGSERIAL | PK | 自增主键 |
| user_id | BIGINT | UNIQUE, NOT NULL | 业务用户 ID（雪花算法生成） |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 登录用户名 |
| nickname | VARCHAR(50) | | 昵称 |
| password | VARCHAR(255) | NOT NULL | BCrypt 加密后的密码 |
| avatar | VARCHAR(500) | | 头像 URL |
| phone | VARCHAR(20) | | 手机号 |
| email | VARCHAR(100) | | 邮箱 |
| role | VARCHAR(20) | DEFAULT 'USER' | 角色：USER / ADMIN / MODERATOR |
| status | SMALLINT | DEFAULT 1 | 状态：1 正常、0 禁用 |
| created_at | TIMESTAMP | DEFAULT NOW | 注册时间 |
| updated_at | TIMESTAMP | DEFAULT NOW | 更新时间 |

#### 3.2.2 user_profile — 用户详情表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGSERIAL | PK | 自增主键 |
| user_id | BIGINT | UNIQUE, FK -> users.user_id | 关联用户 |
| student_id | VARCHAR(30) | | 学号 |
| nickname | VARCHAR(50) | | 昵称 |
| gender | VARCHAR(10) | | 性别：MALE / FEMALE / OTHER |
| bio | VARCHAR(500) | | 个人简介 |
| major | VARCHAR(100) | | 专业 |
| grade | VARCHAR(20) | | 年级（如 2024） |
| created_at | TIMESTAMP | DEFAULT NOW | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW | 更新时间 |

#### 3.2.3 post — 校园墙帖子表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGSERIAL | PK | 自增主键 |
| user_id | BIGINT | FK -> users.user_id | 发布者 |
| content | TEXT | NOT NULL | 帖子正文 |
| images | TEXT | | 图片 URL 列表（JSON 数组格式存储） |
| category | VARCHAR(30) | DEFAULT 'general' | 分类标识 |
| is_anonymous | BOOLEAN | DEFAULT FALSE | 是否匿名发布 |
| view_count | INT | DEFAULT 0 | 浏览次数 |
| like_count | INT | DEFAULT 0 | 点赞数（冗余字段，便于排序） |
| comment_count | INT | DEFAULT 0 | 评论数（冗余字段） |
| status | SMALLINT | DEFAULT 1 | 1 正常、0 已删除、2 审核中 |
| created_at | TIMESTAMP | DEFAULT NOW | 发布时间 |
| updated_at | TIMESTAMP | DEFAULT NOW | 更新时间 |

**索引**：user_id、category、created_at DESC

#### 3.2.4 comment — 评论表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGSERIAL | PK | 自增主键 |
| post_id | BIGINT | FK -> post.id | 所属帖子 |
| user_id | BIGINT | FK -> users.user_id | 评论者 |
| parent_id | BIGINT | DEFAULT 0 | 父评论 ID，0 为顶级评论 |
| content | TEXT | NOT NULL | 评论内容 |
| like_count | INT | DEFAULT 0 | 评论点赞数 |
| status | SMALLINT | DEFAULT 1 | 1 正常、0 已删除 |
| created_at | TIMESTAMP | DEFAULT NOW | 评论时间 |

**索引**：post_id

#### 3.2.5 post_like — 帖子点赞表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGSERIAL | PK | 自增主键 |
| post_id | BIGINT | FK -> post.id | 帖子 ID |
| user_id | BIGINT | FK -> users.user_id | 点赞用户 |
| created_at | TIMESTAMP | DEFAULT NOW | 点赞时间 |

**唯一约束**：(post_id, user_id) — 同一用户对同一帖子只能点赞一次

#### 3.2.6 chat_room — 聊天室表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGSERIAL | PK | 自增主键 |
| room_name | VARCHAR(100) | | 群聊名称（私聊可为空） |
| room_type | VARCHAR(20) | NOT NULL | PRIVATE（私聊）/ GROUP（群聊） |
| owner_id | BIGINT | | 群主用户 ID（群聊时有值） |
| avatar | VARCHAR(500) | | 群头像 |
| created_at | TIMESTAMP | DEFAULT NOW | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT NOW | 更新时间 |

#### 3.2.7 chat_room_member — 聊天室成员表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGSERIAL | PK | 自增主键 |
| room_id | BIGINT | FK -> chat_room.id | 聊天室 ID |
| user_id | BIGINT | FK -> users.user_id | 成员用户 ID |
| role | VARCHAR(20) | DEFAULT 'MEMBER' | OWNER / ADMIN / MEMBER |
| joined_at | TIMESTAMP | DEFAULT NOW | 加入时间 |

**唯一约束**：(room_id, user_id)
**索引**：user_id

#### 3.2.8 chat_message — 聊天消息表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGSERIAL | PK | 自增主键 |
| room_id | BIGINT | FK -> chat_room.id | 聊天室 ID |
| sender_id | BIGINT | FK -> users.user_id | 发送者 ID |
| content | TEXT | NOT NULL | 消息内容 |
| msg_type | VARCHAR(20) | DEFAULT 'TEXT' | TEXT / IMAGE / FILE / SYSTEM |
| status | SMALLINT | DEFAULT 1 | 1 正常、0 已撤回 |
| created_at | TIMESTAMP | DEFAULT NOW | 发送时间 |

**索引**：room_id、created_at DESC

#### 3.2.9 ai_summary — AI 摘要表

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGSERIAL | PK | 自增主键 |
| summary_type | VARCHAR(30) | NOT NULL | DAILY / WEEKLY / CATEGORY |
| category | VARCHAR(30) | | 对应帖子分类（CATEGORY 类型时有值） |
| content | TEXT | NOT NULL | AI 生成的摘要正文 |
| post_count | INT | DEFAULT 0 | 涉及帖子数量 |
| date_range_start | TIMESTAMP | | 摘要覆盖的起始时间 |
| date_range_end | TIMESTAMP | | 摘要覆盖的结束时间 |
| created_at | TIMESTAMP | DEFAULT NOW | 生成时间 |

**索引**：summary_type、created_at DESC

### 3.3 Redis 数据结构设计

| Key 格式 | Redis 类型 | 用途 | 过期策略 |
|----------|-----------|------|---------|
| `user:token:{token}` | String | 存储 userId，用于 Token 验证和主动登出 | 7 天 |
| `user:info:{userId}` | Hash | 用户信息缓存（减少数据库查询） | 30 分钟 |
| `post:like:{postId}` | Set | 点赞该帖子的 userId 集合 | 不过期 |
| `post:view:{postId}` | String | 帖子浏览计数器 | 不过期 |
| `chat:online:{userId}` | String | 用户在线状态标记 | 5 分钟（心跳续期） |
| `chat:unread:{userId}:{roomId}` | String | 某用户在某聊天室的未读消息数 | 不过期 |
| `ai:summary:lock` | String | AI 摘要生成的分布式锁（防重复） | 10 分钟 |

---

## 四、接口设计总览

### 4.1 用户模块接口

| 方法 | 路径 | 说明 | 是否需要登录 |
|------|------|------|-------------|
| POST | `/api/user/register` | 用户注册 | 否 |
| POST | `/api/user/login` | 用户登录 | 否 |
| POST | `/api/user/logout` | 用户登出 | 是 |
| GET | `/api/user/profile` | 获取个人信息 | 是 |
| PUT | `/api/user/profile` | 修改个人信息 | 是 |
| GET | `/api/user/{userId}` | 查看其他用户信息 | 是 |

### 4.2 校园墙接口

| 方法 | 路径 | 说明 | 是否需要登录 |
|------|------|------|-------------|
| POST | `/api/post` | 发布帖子 | 是 |
| GET | `/api/post/list` | 帖子列表（分页，支持 ?page, ?size, ?category） | 是 |
| GET | `/api/post/{id}` | 帖子详情 | 是 |
| DELETE | `/api/post/{id}` | 删除帖子 | 是（本人或管理员） |
| POST | `/api/post/{id}/like` | 点赞/取消点赞 | 是 |
| POST | `/api/post/{id}/comment` | 发表评论 | 是 |
| GET | `/api/post/{id}/comments` | 获取帖子评论列表 | 是 |

### 4.3 聊天模块接口

**HTTP REST 接口：**

| 方法 | 路径 | 说明 | 是否需要登录 |
|------|------|------|-------------|
| POST | `/api/chat/private` | 创建/获取私聊 | 是 |
| POST | `/api/chat/group` | 创建群聊 | 是 |
| GET | `/api/chat/rooms` | 获取聊天室列表（最近会话） | 是 |
| GET | `/api/chat/messages` | 获取历史消息（?roomId, ?page, ?size） | 是 |
| POST | `/api/chat/room/{id}/members` | 添加群成员 | 是（群主/管理员） |
| DELETE | `/api/chat/room/{id}/members/{userId}` | 移除群成员 | 是（群主/管理员） |

**WebSocket 端点：**

| 端点 | 说明 |
|------|------|
| `ws://域名/ws/chat?token={jwt_token}` | 聊天 WebSocket 连接 |

### 4.4 AI 摘要接口

| 方法 | 路径 | 说明 | 是否需要登录 |
|------|------|------|-------------|
| GET | `/api/ai/summary/list` | AI 摘要列表（?type, ?page, ?size） | 是 |
| GET | `/api/ai/summary/{id}` | AI 摘要详情 | 是 |
| POST | `/api/ai/summary/generate` | 手动触发生成摘要 | 是（仅管理员） |

---

## 五、前端页面规划

### 5.1 页面清单

| 页面 | 路由 | 说明 |
|------|------|------|
| 登录页 | `/login` | 用户名 + 密码登录表单 |
| 注册页 | `/register` | 注册表单 |
| 首页/校园墙 | `/post` | 帖子列表 + 分类标签栏 + 发帖入口 |
| 帖子详情 | `/post/:id` | 帖子正文 + 图片 + 评论区 |
| 发布帖子 | `/post/create` | 编辑器 + 分类选择 + 匿名开关 |
| 聊天页 | `/chat` | 左右分栏：左侧会话列表 + 右侧聊天窗口 |
| AI 总结 | `/ai-summary` | AI 摘要卡片列表 + 类型筛选 |
| 个人中心 | `/profile` | 个人信息展示 + 编辑 + 我的帖子 |

### 5.2 公共组件

| 组件 | 说明 |
|------|------|
| NavBar | 顶部导航栏（首页/聊天/AI总结/个人中心） |
| PostCard | 帖子卡片（头像、昵称、内容摘要、点赞/评论/浏览数） |
| CommentList | 评论列表（支持树形展示 + 回复输入框） |
| ChatBubble | 聊天气泡（区分自己/对方，展示头像、内容、时间） |
| UserAvatar | 用户头像组件（带在线状态小圆点） |

### 5.3 状态管理（Pinia Store）

| Store | 管理的状态 |
|-------|-----------|
| userStore | token、用户信息、登录/登出方法 |
| chatStore | WebSocket 连接实例、当前会话、消息列表、未读数 |
| appStore | 全局加载状态、主题等 |

### 5.4 前端关键技术点

| 技术点 | 说明 |
|--------|------|
| Axios 拦截器 | 请求自动注入 Token；响应 401 自动跳转登录页 |
| WebSocket 封装 | 单例模式、自动重连（最多 5 次）、事件监听器模式分发消息 |
| 路由守卫 | 未登录用户访问需认证页面时重定向到登录页 |
| 乐观更新 | 聊天发送消息后本地立即展示，无需等待服务端响应 |
| 虚拟列表（可选） | 消息量大时优化渲染性能 |

---

## 六、实现步骤路线图

按照依赖关系排列的实现顺序，建议严格按此顺序推进：

### 阶段一：基础设施搭建

| 步骤 | 任务 | 说明 |
|------|------|------|
| 1 | 配置 application.yml | 数据库连接、Redis 连接、JWT 密钥、AI API 配置 |
| 2 | 执行数据库建表 SQL | 在 PostgreSQL 中创建所有 9 张表和索引 |
| 3 | 添加 Maven 依赖 | JWT(jjwt)、WebSocket、Security、Validation、WebFlux、FastJSON |
| 4 | 配置 MyBatis-Plus 分页插件 | 编写 MybatisPlusConfig 配置类，注册分页拦截器 |
| 5 | 配置 Redis 序列化 | 使用 JSON 序列化替代默认 JDK 序列化，避免乱码 |
| 6 | 编写 JWT 工具类 | 生成 Token 和解析 Token 两个核心方法 |
| 7 | 编写雪花 ID 工具类 | 生成全局唯一的业务用户 ID |
| 8 | 配置 Spring Security | 放行登录/注册接口，其余接口需认证 |
| 9 | 编写 Token 拦截器 | 统一校验请求头中的 JWT Token |
| 10 | 编写全局异常处理器 | 统一捕获异常，返回标准 Result 格式 |
| 11 | 配置 CORS 跨域 | 允许前端开发服务器的跨域请求 |

### 阶段二：用户模块

| 步骤 | 任务 | 说明 |
|------|------|------|
| 12 | 完善 Users 实体类 | 添加 status、created_at、updated_at 等字段 |
| 13 | 编写 DTO 和 VO | LoginDTO、RegisterDTO、UserVO |
| 14 | 编写 UserMapper + UserProfileMapper | 继承 BaseMapper，复杂查询可自定义 |
| 15 | 编写 UserService + UserServiceImpl | 注册、登录、获取信息、修改信息 |
| 16 | 编写 UserController | 对外暴露 REST 接口 |
| 17 | 接口测试 | 用 Postman / Apifox 逐一测试用户模块接口 |

### 阶段三：校园墙模块

| 步骤 | 任务 | 说明 |
|------|------|------|
| 18 | 编写 Post / Comment / PostLike 实体类 | 对应数据库表 |
| 19 | 编写 PostCreateDTO、CommentCreateDTO | 前端传入参数对象 |
| 20 | 编写 PostVO、PostDetailVO、CommentVO | 返回给前端的视图对象 |
| 21 | 编写 PostMapper / CommentMapper / PostLikeMapper | 其中 PostMapper 需要自定义点赞数增减 SQL |
| 22 | 编写 PostService + PostServiceImpl | 发帖、列表、详情、点赞、删除 |
| 23 | 编写 CommentService + CommentServiceImpl | 发表评论、获取评论列表（树形组装） |
| 24 | 编写 PostController + CommentController | 对外暴露 REST 接口 |
| 25 | 接口测试 | 测试所有校园墙接口，特别关注点赞的 Redis 逻辑 |

### 阶段四：聊天模块

| 步骤 | 任务 | 说明 |
|------|------|------|
| 26 | 编写 ChatRoom / ChatRoomMember / ChatMessage 实体类 | 对应数据库表 |
| 27 | 编写 ChatRoomVO、ChatMessageVO | 返回给前端的视图对象 |
| 28 | 编写 ChatRoomMapper / ChatRoomMemberMapper / ChatMessageMapper | 数据访问层 |
| 29 | 编写 WebSocket 配置类 | 注册 WebSocket 端点和握手拦截器 |
| 30 | 编写 WebSocket 握手拦截器 | 在握手阶段验证 Token，提取 userId 存入 Session |
| 31 | 编写 WebSocket 消息处理器 | 连接管理 + 消息分发 + 离线消息计数 |
| 32 | 编写 ChatService + ChatServiceImpl | 创建聊天室、获取会话列表、获取历史消息 |
| 33 | 编写 ChatController | REST 接口部分 |
| 34 | WebSocket 测试 | 用浏览器控制台或 Postman 的 WebSocket 工具测试 |

### 阶段五：AI 总结模块

| 步骤 | 任务 | 说明 |
|------|------|------|
| 35 | 编写 AiSummary 实体类 + AiSummaryMapper | 数据层 |
| 36 | 编写 AiSummaryService | 核心：构建 Prompt、调用 AI API、解析结果、存储 |
| 37 | 编写定时任务类 | 每日 23:00 和每周日 23:00 自动触发 |
| 38 | 编写 AiSummaryController | 摘要列表查询 + 手动触发接口 |
| 39 | 接口测试 | 手动触发生成，验证 AI 返回结果的正确性 |

### 阶段六：前端开发

| 步骤 | 任务 | 说明 |
|------|------|------|
| 40 | 初始化 Vue 项目 | 安装 Arco Design、Axios、Vue Router、Pinia |
| 41 | 封装 Axios 请求模块 | 基础 URL、Token 注入拦截器、错误统一处理 |
| 42 | 配置路由和路由守卫 | 页面路由表 + 未登录重定向 |
| 43 | 编写 Pinia Store | userStore（登录态）、chatStore（WebSocket 连接） |
| 44 | 开发登录/注册页面 | 表单校验 + 调用后端接口 |
| 45 | 开发校园墙列表页 | PostCard 组件 + 分类标签 + 分页加载 |
| 46 | 开发帖子详情页 | 帖子正文 + 图片展示 + 评论列表 + 评论输入 |
| 47 | 开发发帖页面 | 富文本/文本域 + 图片上传 + 分类选择 + 匿名开关 |
| 48 | 封装 WebSocket 客户端 | 单例、自动重连、事件分发 |
| 49 | 开发聊天页面 | 左侧会话列表 + 右侧聊天窗口 + 消息气泡 |
| 50 | 开发 AI 总结页面 | 摘要卡片列表 + 类型筛选标签 |
| 51 | 全局样式与适配 | 统一风格、响应式布局调整 |

### 阶段七：联调与完善

| 步骤 | 任务 | 说明 |
|------|------|------|
| 52 | 前后端联调 | 逐模块联调，修复接口对接问题 |
| 53 | 配置 Nginx | 前端静态资源 + 后端 API 反向代理 + WebSocket 代理 |
| 54 | 边界情况处理 | 空数据提示、网络异常提示、加载状态 |
| 55 | 基础性能检查 | Redis 缓存命中率、慢 SQL 排查、索引有效性 |

---

## 七、后端分层架构说明（面向初学者）

### 7.1 分层概览

```
Controller 层（接收请求）
    ↓ 调用
Service 层（业务逻辑）
    ↓ 调用
Mapper 层（数据库操作）
    ↓ 操作
数据库（PostgreSQL / Redis）
```

### 7.2 各层职责

| 层 | 职责 | 命名规范 |
|----|------|---------|
| Controller | 接收 HTTP 请求，参数校验，调用 Service，返回结果 | XxxController |
| Service (接口) | 定义业务方法签名 | XxxService |
| Service (实现) | 编写具体业务逻辑，调用 Mapper 操作数据库 | XxxServiceImpl |
| Mapper | 定义数据库操作方法，继承 MyBatis-Plus 的 BaseMapper | XxxMapper |
| Entity | 对应数据库表的 Java 对象 | 表名的驼峰形式 |
| DTO | 前端传给后端的请求参数对象 | XxxDTO |
| VO | 后端返回给前端的视图数据对象 | XxxVO |

### 7.3 为什么需要 DTO 和 VO？

| 对象 | 作用 | 举例 |
|------|------|------|
| Entity | 完整映射数据库表，包含所有字段（含密码等敏感信息） | Users 包含 password 字段 |
| DTO | 只接收前端需要传的字段，可附加校验规则 | LoginDTO 只有 username 和 password |
| VO | 只返回前端需要展示的字段，排除敏感信息，可组合多表数据 | UserVO 不含 password，PostVO 附带用户昵称和头像 |

### 7.4 单个功能的开发顺序

```
1. 建表（如果还没建）
2. 编写 Entity 实体类（对应表字段）
3. 编写 DTO（前端入参）和 VO（返回给前端的数据）
4. 编写 Mapper 接口（继承 BaseMapper，复杂查询写自定义 SQL）
5. 编写 Service 接口 + ServiceImpl 实现类（核心业务逻辑）
6. 编写 Controller（暴露 REST 接口）
7. 使用 Postman 测试接口
```

### 7.5 后端包结构

```
com.community.communitybackend/
├── CommunityBackendApplication.java    -- 启动类
├── common/
│   ├── utils/          -- 工具类（Result、JwtUtil、SnowflakeUtil）
│   ├── config/         -- 配置类（Redis、WebSocket、Security、MyBatisPlus、CORS）
│   ├── interceptor/    -- 拦截器（Token 验证）
│   └── exception/      -- 全局异常处理
├── entity/             -- 实体类（对应数据库表）
├── mapper/             -- MyBatis-Plus Mapper 接口
├── service/            -- Service 接口
│   └── impl/           -- Service 实现类
├── controller/         -- REST 控制器
├── dto/                -- 请求参数对象
├── vo/                 -- 返回视图对象
└── websocket/          -- WebSocket 处理器
```

---

## 八、前端目录结构说明

```
frontend/src/
├── App.vue                 -- 根组件
├── main.js                 -- 入口文件（注册 Arco Design、路由、Pinia）
├── api/                    -- 后端接口调用
│   ├── request.js          -- Axios 实例封装（拦截器）
│   ├── user.js             -- 用户相关接口函数
│   ├── post.js             -- 帖子相关接口函数
│   ├── chat.js             -- 聊天相关接口函数
│   └── ai.js               -- AI 摘要相关接口函数
├── router/
│   └── index.js            -- 路由表 + 路由守卫
├── stores/                 -- Pinia 状态管理
│   ├── user.js             -- 登录态、用户信息
│   ├── chat.js             -- WebSocket、消息、会话
│   └── app.js              -- 全局状态
├── views/                  -- 页面级组件
│   ├── Login.vue
│   ├── Register.vue
│   ├── Home.vue            -- 主布局（含 NavBar + router-view）
│   ├── post/
│   │   ├── PostList.vue
│   │   ├── PostDetail.vue
│   │   └── PostCreate.vue
│   ├── chat/
│   │   ├── ChatLayout.vue  -- 左右分栏布局
│   │   ├── ChatList.vue    -- 会话列表
│   │   └── ChatWindow.vue  -- 聊天窗口
│   └── ai/
│       └── AiSummary.vue
├── components/             -- 可复用公共组件
│   ├── NavBar.vue
│   ├── PostCard.vue
│   ├── CommentList.vue
│   ├── ChatBubble.vue
│   └── UserAvatar.vue
├── utils/
│   ├── websocket.js        -- WebSocket 客户端封装
│   └── time.js             -- 时间格式化
└── assets/
    └── styles/
        └── global.css
```

---

## 九、安全与性能注意事项

### 9.1 安全要求

| 事项 | 要求 |
|------|------|
| 密码存储 | 必须使用 BCrypt 加密，禁止明文存储 |
| SQL 注入 | 使用 MyBatis-Plus 的参数化查询（Wrapper），禁止手动拼接 SQL |
| XSS 防护 | Vue 模板默认转义 HTML，禁止使用 v-html 展示用户输入内容 |
| Token 安全 | JWT 密钥不少于 32 位；Token 存入 Redis 用于主动作废 |
| 接口权限 | 拦截器统一校验 Token；删除帖子需校验是本人或管理员 |
| 文件上传 | 校验文件类型和大小，禁止上传可执行文件 |

### 9.2 性能要求

| 事项 | 要求 |
|------|------|
| 分页查询 | 所有列表接口必须分页，禁止一次加载全量数据 |
| Redis 缓存 | 用户信息、热门帖子等频繁读取的数据走 Redis 缓存 |
| Redis 序列化 | 使用 JSON 序列化，避免 JDK 默认序列化导致乱码和体积膨胀 |
| 浏览计数 | 使用 Redis INCR 原子操作，定时批量同步到数据库 |
| AI 调用 | 设置合理的超时时间（建议 30 秒），使用异步/非阻塞调用 |
| WebSocket | 用户断开连接后及时清理会话，避免内存泄漏 |
| 数据库索引 | 确保 WHERE 和 ORDER BY 涉及的字段已建索引 |

---

## 十、初学者常见概念解释

### 10.1 为什么用 Redis + PostgreSQL 两个数据库？

| 数据库 | 特点 | 存什么 |
|--------|------|--------|
| PostgreSQL | 数据持久化、支持复杂查询（JOIN、GROUP BY） | 用户、帖子、评论、聊天记录等所有核心业务数据 |
| Redis | 内存存储、读写极快、支持过期时间 | Token、点赞集合、在线状态、未读计数、缓存、分布式锁 |

**简单理解**：PostgreSQL 是"硬盘"，数据不会丢；Redis 是"内存"，速度快但重启会丢（重要数据需要持久化方案）。

### 10.2 WebSocket 和 HTTP 的区别

| 对比 | HTTP | WebSocket |
|------|------|-----------|
| 连接方式 | 每次请求建立连接，响应后断开 | 一次握手后保持长连接 |
| 通信方向 | 客户端主动请求，服务端被动响应 | 双向通信，服务端可主动推送 |
| 适用场景 | 获取数据、提交表单等普通操作 | 聊天、实时通知等需要即时推送的场景 |

**在本项目中**：
- 创建聊天室、获取历史消息等操作用 HTTP
- 实时发送消息、接收消息推送用 WebSocket

### 10.3 JWT Token 认证流程

```
1. 用户登录成功 → 后端生成 JWT Token → 返回给前端
2. 前端将 Token 存入 localStorage
3. 之后每次请求 → 前端自动在请求头加 Authorization: Bearer {token}
4. 后端拦截器 → 验证 Token 签名和有效期 → 提取用户 ID → 放行请求
5. Token 过期 → 后端返回 401 → 前端清除 Token → 跳转登录页
6. 用户主动登出 → 后端从 Redis 删除 Token → 该 Token 即刻失效
```

### 10.4 什么是"雪花算法"？

用于生成全局唯一的分布式 ID（64 位长整型数字），由时间戳 + 机器 ID + 序列号组成。
- 为什么不用数据库自增 ID？ → 自增 ID 容易被猜测（如 `/api/user/1`、`/api/user/2`），雪花 ID 不可预测且全局唯一。
- 本项目中用于生成 `user_id`（业务用户 ID）。

### 10.5 什么是"分布式锁"？

防止多个请求同时执行同一个操作。本项目中用于 AI 摘要生成：
- 场景：定时任务触发 + 管理员手动触发可能同时发生
- 方案：生成前先在 Redis 设置一个 key（SET NX），设置成功说明获得了锁，可以执行；设置失败说明有其他任务在执行，直接返回"正在生成中"
- 执行完毕后删除 Redis key，释放锁

---

## 十一、技术依赖清单

### 11.1 后端依赖

| 依赖 | 用途 |
|------|------|
| spring-boot-starter-web | Web MVC、REST 接口 |
| spring-boot-starter-websocket | WebSocket 支持 |
| spring-boot-starter-security | 密码加密（BCrypt） |
| spring-boot-starter-validation | 参数校验（@NotBlank 等注解） |
| spring-boot-starter-webflux | WebClient HTTP 客户端（调用 AI API） |
| spring-data-redis | Redis 操作 |
| mybatis-plus-spring-boot3-starter | MyBatis-Plus ORM 框架 |
| postgresql (驱动) | PostgreSQL 数据库驱动 |
| jjwt (api + impl + jackson) | JWT Token 生成与解析 |
| fastjson2 | JSON 序列化/反序列化 |
| lombok | 自动生成 getter/setter/构造器等 |

### 11.2 前端依赖

| 依赖 | 用途 |
|------|------|
| vue (3.x) | 前端框架 |
| @arco-design/web-vue | UI 组件库 |
| vue-router (4.x) | 路由管理 |
| pinia | 状态管理 |
| axios | HTTP 请求 |

---

## 十二、配置文件清单

| 文件 | 位置 | 说明 |
|------|------|------|
| application.yml | 后端 resources/ | 数据库、Redis、JWT、AI API 配置 |
| pom.xml | 后端根目录 | Maven 依赖管理 |
| nginx.conf | nginx/conf.d/ | Nginx 反向代理配置 |
| vite.config.js | 前端根目录 | Vite 构建配置（代理等） |
| .env.development | 前端根目录 | 开发环境变量 |

### application.yml 核心配置项

| 配置项 | 说明 |
|--------|------|
| spring.datasource.url | PostgreSQL 连接地址 |
| spring.datasource.username/password | 数据库账号密码 |
| spring.data.redis.host/port | Redis 连接地址 |
| jwt.secret | JWT 签名密钥（不少于 32 位） |
| jwt.expiration | Token 有效期（毫秒，建议 7 天 = 604800000） |
| ai.api.url | AI 大模型 API 地址 |
| ai.api.key | AI API 密钥 |
| ai.api.model | AI 模型名称 |
